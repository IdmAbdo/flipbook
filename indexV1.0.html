<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Mon Livre PDF – V1.0 + pliage</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
    h1{text-align:center;margin:12px 0}
    .bar{display:flex;justify-content:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
    button{padding:8px 16px;background:#444;border:none;color:#fff;border-radius:5px;cursor:pointer;font-size:15px}
    button:disabled{opacity:.4;cursor:not-allowed}
    #status{margin-left:6px;align-self:center;white-space:nowrap}
    #container{display:flex;justify-content:center;align-items:center;height:calc(100vh - 80px)}
    #flipbook{background:#222;display:none;/* turn.js appliquera perspective */}
    canvas{background:#fff}
    /* plein-écran */
    :fullscreen #flipbook{width:100vw!important;height:100vh!important}
  </style>
</head>
<body>

<h1>Mon Livre PDF</h1>
<div class="bar">
  <button id="prev" disabled>« Précédent</button>
  <button id="next" disabled>Suivant »</button>
  <button id="fs">Plein écran ⤢</button>
  <span id="status">Chargement…</span>
</div>

<div id="container"><div id="flipbook"></div></div>

<!-- dépendances locales -->
<script src="libs/jquery.min.js"></script>
<script src="libs/turn.min.js"></script>
<script src="libs/pdf.js"></script>
<script>
  // PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.js';

  const PDF_URL = 'pdf/livre.pdf',
        flip    = $('#flipbook'),
        status  = $('#status'),
        prevBtn = $('#prev'),
        nextBtn = $('#next'),
        fsBtn   = $('#fs');

  let pdfDoc, totalPages, zoom = 1;

  // 1 page en portrait, 2 en paysage/tablette/PC
  function doubleMode(){
    return window.innerWidth >= 768 || window.matchMedia('(orientation: landscape)').matches;
  }

  // calcule l’échelle
  function scaleFor(vp){
    const header = $('.bar').outerHeight() + 20,
          availW = window.innerWidth  - 32,
          availH = window.innerHeight - header,
          pages  = doubleMode() ? 2 : 1,
          byW    = (availW/pages)/vp.width,
          byH    =  availH       /vp.height;
    return (pages===1 ? byW : Math.min(byW,byH)) * zoom;
  }

  // rend la page n° i → canvas
  async function renderPage(i){
    const page = await pdfDoc.getPage(i),
          vp0  = page.getViewport({scale:1}),
          s    = scaleFor(vp0),
          vp   = page.getViewport({scale:s}),
          c    = document.createElement('canvas');
    c.width  = vp.width;
    c.height = vp.height;
    await page.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    return c;
  }

  // (re)construction complète
  async function build(){
    try{ flip.turn('destroy').empty(); }catch{}
    status.text('Chargement…');
    zoom = 1;

    if(!pdfDoc){
      pdfDoc    = await pdfjsLib.getDocument(PDF_URL).promise;
      totalPages = pdfDoc.numPages;
    }

    for(let i=1;i<=totalPages;i++){
      const cv = await renderPage(i);
      $('<div class="page">').append(cv).appendTo(flip);
    }

    const first = flip.find('canvas')[0];
    flip.turn({
      display:   doubleMode() ? 'double' : 'single',
      width:     first.width  * (doubleMode()?2:1),
      height:    first.height,
      autoCenter:true,
      gradients: true,      // active l’ombre du pli
      elevation: 50,        // relèvement 3D
      cornerSize: 100,      // zone de “tirage” du coin
      duration:  600
    }).show();

    status.text(`${totalPages} pages`);
    prevBtn.prop('disabled',false);
    nextBtn.prop('disabled',false);
  }

  // navigation
  prevBtn.on('click',()=>flip.turn('previous'));
  nextBtn.on('click',()=>flip.turn('next'));

  // swipe mobile
  flip.on('touchstart', e=> flip.data('x0', e.originalEvent.touches[0].clientX));
  flip.on('touchend',   e=>{
    const x0=flip.data('x0'),
          x1=e.originalEvent.changedTouches[0].clientX;
    if(x0!=null){
      if(x1 - x0 > 50) flip.turn('previous');
      if(x0 - x1 > 50) flip.turn('next');
    }
    flip.removeData('x0');
  });

  // zoom double-tap
  flip.on('dblclick',()=>{
    zoom = zoom===1 ? 1.5 : 1;
    build();
  });

  // plein-écran
  fsBtn.on('click',()=>{
    const el=document.documentElement;
    (!document.fullscreenElement
      ? el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen
      : document.exitFullscreen  || document.webkitExitFullscreen || document.msExitFullscreen
    ).call(el);
  });

  // rebuild si resize/orientation
  window.addEventListener('resize', build);

  // lancement initial
  build().catch(e=>{
    status.text('Erreur : '+e.message);
    console.error(e);
  });
</script>
</body>
</html>
