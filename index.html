<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mon Livre PDF – V1.0+Flip</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body {
      margin: 0; background: #111; color: #fff;
      font-family: sans-serif; text-align: center;
    }
    h1 { margin: 1rem 0; }
    .nav {
      display: flex; justify-content: center; gap: 1rem;
      margin-bottom: .5rem;
    }
    .nav button {
      padding: .6rem 1rem; background: #333;
      border: none; border-radius: 4px; color: #fff;
      cursor: pointer; font-size: 1rem;
    }
    .nav button:disabled { opacity:.5; cursor:default }
    #status { align-self:center; margin-left:.5rem }
    #flipbook-wrapper {
      display: flex; justify-content: center; align-items: center;
      width: 100vw; height: calc(100vh - 4rem); /* laisse de la place au header */
      overflow: hidden;
    }
    #flipbook {
      background: #222;
      border-radius: 8px;
      /* dimensions initiales, seront redimensionnées par JS */
      width: 90vw;
      height: 80vh;
    }
    .page {
      background: #fff;
      overflow: hidden;
    }
    .page canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

  <h1>Mon Livre PDF – V1.0+Flip</h1>
  <div class="nav">
    <button id="prev" disabled>« Précédent</button>
    <button id="next" disabled>Suivant »</button>
    <button id="fs">Plein écran ⛶</button>
    <span id="status">Chargement…</span>
  </div>
  <div id="flipbook-wrapper">
    <div id="flipbook"></div>
  </div>

  <!-- Librairies locales -->
  <script src="libs/jquery.min.js"></script>
  <script src="libs/turn.min.js"></script>
  <script src="libs/pdf.js"></script>
  <script src="libs/pdf.worker.js"></script>
  <script>
  (function(){
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';
    const URL = 'pdf/livre.pdf';
    let pdfDoc, totalPages, currentPage = 1;

    const $flip = $('#flipbook'),
          $prev = $('#prev'),
          $next = $('#next'),
          $fs   = $('#fs'),
          $status = $('#status');

    // 1 ou 2 pages selon orientation
    function mode() {
      return window.innerWidth > window.innerHeight ? 'double' : 'single';
    }

    // met à jour l'état des boutons et le texte
    function updateNav() {
      const m = mode();
      $prev.prop('disabled', currentPage <= 1);
      $next.prop('disabled',
        m==='double'
          ? (currentPage+1 > totalPages)
          : (currentPage   >= totalPages)
      );
      if (m==='double') {
        $status.text(`Pages ${currentPage}-${Math.min(currentPage+1,totalPages)} / ${totalPages}`);
      } else {
        $status.text(`Page ${currentPage} / ${totalPages}`);
      }
    }

    // initialise turn.js
    function initTurn() {
      // détruit si déjà initialisé
      if ($flip.data('turn')) $flip.turn('destroy').empty();

      // ajoute une div.page par page
      for (let i=1; i<=totalPages; i++) {
        $flip.append($('<div>').addClass('page').attr('data-page', i));
      }

      // dimensions de l'ebook
      const disp = mode(),
            w = Math.min(window.innerWidth*0.9, 1000),
            h = Math.min(window.innerHeight*0.8, 700);

      $flip.css({width: w, height: h});
      $flip.turn({
        width: w,
        height: h,
        display: disp,
        autoCenter: true,
        gradients: true,
        elevation: 50,
        duration: 600,
        cornerSize: 100,
        when: {
          turned: (e, p) => {
            currentPage = p;
            renderVisible();
            updateNav();
          }
        }
      });

      // position initiale
      $flip.turn('page', currentPage);
      renderVisible();
      updateNav();
    }

    // rend une seule page dans son div
    function renderPage(i) {
      const $pg = $flip.find(`.page[data-page=${i}]`);
      if (!$pg.length || $pg.data('rendered')) return;
      pdfDoc.getPage(i).then(page => {
        const viewport = page.getViewport({ scale: 1 }),
              pw = $flip.width() / (mode()==='double'?2:1),
              ph = $flip.height(),
              scale = Math.min(pw/viewport.width, ph/viewport.height),
              vp = page.getViewport({ scale });

        const canvas = document.createElement('canvas'),
              ctx = canvas.getContext('2d');
        canvas.width = vp.width; canvas.height = vp.height;
        canvas.style.width = pw + 'px';
        canvas.style.height= ph + 'px';

        page.render({canvasContext: ctx, viewport: vp}).promise.then(() => {
          $pg.append(canvas).data('rendered', true);
        });
      });
    }

    // rend page courante et suivante si double
    function renderVisible() {
      renderPage(currentPage);
      if (mode()==='double' && currentPage+1 <= totalPages) {
        renderPage(currentPage+1);
      }
    }

    // navigation
    $prev.on('click', () => {
      currentPage = mode()==='double'
        ? Math.max(1, currentPage-2)
        : Math.max(1, currentPage-1);
      $flip.turn('page', currentPage);
    });
    $next.on('click', () => {
      currentPage = mode()==='double'
        ? Math.min(currentPage+2, totalPages)
        : Math.min(currentPage+1, totalPages);
      $flip.turn('page', currentPage);
    });

    // plein écran
    $fs.on('click', ()=> {
      const el = document.documentElement;
      if (!document.fullscreenElement) el.requestFullscreen?.();
      else document.exitFullscreen?.();
      setTimeout(initTurn, 500);
    });

    // swipe
    let x0=0;
    $flip.on('touchstart', e=> x0 = e.originalEvent.touches[0].clientX)
         .on('touchend',   e=>{
           const x1 = e.originalEvent.changedTouches[0].clientX;
           if (x1 - x0 > 50) $prev.click();
           if (x0 - x1 > 50) $next.click();
         });

    // resize/orientation
    let to;
    $(window).on('resize orientationchange', ()=>{
      clearTimeout(to);
      to = setTimeout(initTurn, 250);
    });

    // chargement PDF
    pdfjsLib.getDocument(URL).promise.then(doc => {
      pdfDoc = doc; totalPages = doc.numPages;
      $status.text(`0 / ${totalPages}`);
      initTurn();
    }).catch(err => {
      $status.text(`Erreur : ${err.message}`);
      console.error(err);
    });

  })();
  </script>
</body>
</html>
