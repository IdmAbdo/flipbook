<script>
  /* ------------------------------------------------------ */
  /*  CONFIG PDF.js                                         */
  /* ------------------------------------------------------ */
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';

  const ASPECT = 1.4;
  const $flip  = $('#flipbook');
  let pdfName  = null;

  function layout(){
    const availW = innerWidth  * .95;
    const availH = innerHeight * .95;
    const landscape = innerWidth > innerHeight;

    if (landscape){
      let h = availH;
      let w = (2 * h) / ASPECT;
      if (w > availW){ w = availW; h = (w * ASPECT) / 2; }
      return {width:Math.floor(w), height:Math.floor(h), mode:'double'};
    } else {
      let w = Math.min(availW, 600);
      let h = w * ASPECT;
      if (h > availH){ h = availH; w = h / ASPECT; }
      return {width:Math.floor(w), height:Math.floor(h), mode:'single'};
    }
  }

  async function makePage(page){
    const vp = page.getViewport({scale:1.5});
    const c  = document.createElement('canvas'), ctx = c.getContext('2d');
    c.width  = vp.width; c.height = vp.height;
    await page.render({canvasContext:ctx, viewport:vp}).promise;
    return $('<div>',{class:'page'}).append($('<img>',{src:c.toDataURL()}));
  }

  async function loadPDF(name){
    if(name === pdfName) return;
    pdfName = name;

    if($flip.data('turn')) $flip.turn('destroy').empty(); else $flip.empty();

    const pdf = await pdfjsLib.getDocument(`pdf/${name}`).promise;
    for(let p=1; p<=pdf.numPages; p++){
      $flip.append(await makePage(await pdf.getPage(p)));
    }
    initTurn();
    refresh(); // ðŸ”¹ Sâ€™assure que le mode est correct aprÃ¨s chargement
  }

  function initTurn(){
    const {width, height, mode} = layout();
    $flip.turn({
      width, height, display:mode, autoCenter:true,
      elevation:0, gradients:false, duration:400
    });
  }

  function refresh(){
    if(!$flip.data('turn')) return;
    const {width, height, mode} = layout();
    $flip.turn('display', mode);
    $flip.turn('size', width, height);
  }

  $('#pdfSel').on('change', e => loadPDF(e.target.value));

  $('#fsBtn').on('click', ()=>{
    document.fullscreenElement
      ? document.exitFullscreen?.()
      : document.documentElement.requestFullscreen?.();
  });

  document.addEventListener('fullscreenchange', ()=> setTimeout(refresh,150));
  window.addEventListener('resize', () => setTimeout(refresh,150));
  window.addEventListener('orientationchange', () => setTimeout(refresh,150)); // ðŸ”¹ Nouveau

  loadPDF($('#pdfSel').val());
</script>
