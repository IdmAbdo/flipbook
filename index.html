<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mon Livre PDF</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      background: #111; color: #fff; margin: 0; font-family: sans-serif;
    }
    h1 { text-align:center; margin:20px 0; }
    .nav {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;
    }
    button {
      padding: 12px 22px; background: #333; color: #fff; border-radius: 8px;
      border: none; font-size: 18px; margin: 2px 4px;
      transition: background 0.2s;
    }
    button:active { background: #555; }
    #status { font-size: 18px; margin-left: 18px; }
    #container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 70vh;
      width: 100vw;
    }
    #flipbook {
      background: #222;
      box-shadow: 0 8px 32px #0008;
      margin: auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    @media (max-width: 850px) {
      #flipbook { width: 95vw !important; height: 65vw !important; max-width: 100vw; }
    }
    @media (max-width: 600px) {
      #flipbook { width: 100vw !important; height: 65vw !important; }
      button { font-size: 15px; }
    }
  </style>
</head>
<body>
  <h1>Mon Livre PDF</h1>
  <div class="nav">
    <button id="prev">« Précédent</button>
    <button id="next">Suivant »</button>
    <button id="fullscreen">Plein écran ⛶</button>
    <span id="status">Chargement…</span>
  </div>
  <div id="container">
    <div id="flipbook"></div>
  </div>
  <!-- Dépendances JS -->
  <script src="libs/jquery.min.js"></script>
  <script src="libs/turn.min.js"></script>
  <script src="libs/pdf.min.js"></script>
  <script>
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';

    const PAGE_WIDTH = 420, PAGE_HEIGHT = 600;
    const PDF_URL = "pdf/livre.pdf";
    let pdfDoc = null, totalPages = 0;

    // --- Correction navigation ---
    function updateNav() {
      const currentPage = $("#flipbook").turn("page");
      const lastPage = $("#flipbook").turn("pages");
      $("#prev").prop("disabled", currentPage <= 1);
      $("#next").prop("disabled", currentPage >= lastPage);
    }

    // Crée le flipbook
    function initFlipbook(total) {
      $("#flipbook").turn({
        width: PAGE_WIDTH * 2,
        height: PAGE_HEIGHT,
        autoCenter: true,
        acceleration: true,
        display: "double",
        gradients: true,
        elevation: 50,
        when: {
          turned: function(e, page) {
            $("#status").text(`Page ${(page-1) * 2 + 1} - ${Math.min(page*2, totalPages)} / ${totalPages}`);
            updateNav();
          }
        }
      });
      updateNav();
    }

    // Plein écran
    function openFullscreen(elem) {
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    }
    document.getElementById('fullscreen').onclick = function() {
      openFullscreen(document.getElementById('flipbook'));
    };

    // --- Navigation boutons (corrigé) ---
    $("#prev").on("click", function() {
      $("#flipbook").turn("previous");
      updateNav();
    });
    $("#next").on("click", function() {
      $("#flipbook").turn("next");
      updateNav();
    });

    // Rendu d'une page PDF vers Canvas
    function renderPage(num) {
      return pdfDoc.getPage(num).then(function(page) {
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = PAGE_WIDTH;
        canvas.height = PAGE_HEIGHT;
        const viewport = page.getViewport({ scale: PAGE_WIDTH / page.getViewport({scale:1}).width });
        return page.render({canvasContext: context, viewport: viewport}).promise.then(function() {
          return canvas;
        });
      });
    }

    // Charge le PDF et ajoute chaque page dans le flipbook
    pdfjsLib.getDocument(PDF_URL).promise.then(function(pdf) {
      pdfDoc = pdf;
      totalPages = pdf.numPages;
      $("#status").text(`0 / ${totalPages} pages chargées`);
      let promises = [];
      for(let i=1; i<=totalPages; i++) promises.push(renderPage(i));
      Promise.all(promises).then(function(canvases) {
        canvases.forEach(canvas => $("#flipbook").append(canvas));
        initFlipbook(totalPages);
        $("#status").text(`${totalPages} pages`);
      });
    }).catch(function(err){
      $("#status").text("Erreur PDF : " + err.message);
    });
  </script>
</body>
</html>
