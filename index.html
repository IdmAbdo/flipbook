<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flipbook V3.3 – Effets persistants</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;font-family:sans-serif;background:#111;color:#fff;overflow:hidden;transition:background .5s,color .5s}
    body.light{background:#f0f0f0;color:#222}
    .flipbook-container{position:relative;height:100%;width:100%;display:flex;justify-content:center;align-items:center;overflow:hidden}
    #flipbook{position:relative;max-width:100%;max-height:100%;box-sizing:border-box}
    .page img{width:100%;height:auto;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.7);user-select:none;-webkit-user-drag:none;transition:filter .5s}
    body.light .page img{box-shadow:0 5px 15px rgba(0,0,0,.15)}
    .footer{position:absolute;bottom:0;left:0;right:0;height:60px;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;gap:10px;padding:0 10px;box-sizing:border-box;z-index:1000}
    body.light .footer{background:rgba(255,255,255,.8)}
    select,button{padding:.5rem 1rem;font-size:1rem;background:#222;color:#fff;border:none;border-radius:4px;cursor:pointer;user-select:none;transition:background .3s,color .3s}
    body.light select,body.light button{background:#ddd;color:#222}
    select{min-width:120px}
  </style>
</head>
<body>
  <div class="flipbook-container">
    <div id="flipbook" class="flipbook"></div>
    <div class="footer">
      <label for="pdfSelector" style="margin-right:10px;user-select:none">Choisir un livre :</label>
      <select id="pdfSelector">
        <option value="livre.pdf">Livre 1</option>
        <option value="livre01.pdf">Livre 2</option>
        <option value="livre02.pdf">Livre 3</option>
      </select>
      <button id="fullscreen">Plein écran ⛶</button>
    </div>
  </div>

  <script src="libs/jquery.min.js"></script>
  <script src="libs/turn.min.js"></script>
  <script src="libs/pdf.min.js"></script>
  <script>
    /* === Configuration worker PDF.js === */
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';

    /* === Variables d’état === */
    let pdfDoc      = null;   // instance PDF.js
    let lastPDFName = null;   // nom du pdf courant
    let isLoading   = false;  // verrou anti‑concurrence

    /* === Thème auto jour/nuit === */
    function applyAutoTheme(){
      const h = new Date().getHours();
      document.body.classList.toggle('light', h>=7 && h<19);
    }

    /* === Calcul taille + mode (single/double) === */
    function getFlipbookSize(){
      const landscape = window.innerWidth > window.innerHeight;
      const maxW = window.innerWidth, maxH = window.innerHeight;
      let w,h;
      if(landscape){
        h = maxH*0.95;
        w = Math.min(Math.round(h/0.7), maxW*0.95);
      }else{
        w = Math.min(maxW*0.95, 600);
        h = Math.round(w*1.4);
        if(h>maxH){ h=maxH*0.95; w=Math.round(h/1.4); }
      }
      return {width:w, height:h, mode: landscape ? 'double' : 'single'};
    }

    /* === Rendu d’une page === */
    async function renderPage(page){
      const viewport = page.getViewport({scale:1.5});
      const canvas   = document.createElement('canvas');
      const ctx      = canvas.getContext('2d');
      canvas.width  = viewport.width;
      canvas.height = viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      const div = $('<div/>',{class:'page'});
      div.append($('<img/>').attr('src', canvas.toDataURL()));
      return div;
    }

    /* === Chargement initial (ou changement de PDF) === */
    async function ensurePDFLoaded(pdfName){
      if(pdfName===lastPDFName && $('#flipbook').data('turn')) return; // déjà prêt
      if(isLoading) return;                       // un chargement est déjà en cours
      isLoading = true; lastPDFName = pdfName;

      // nettoyage
      if($('#flipbook').data('turn')) $('#flipbook').turn('destroy').empty();

      try{
        pdfDoc = await pdfjsLib.getDocument(`pdf/${pdfName}`).promise;
        for(let i=1;i<=pdfDoc.numPages;i++){
          const pg = await renderPage(await pdfDoc.getPage(i));
          $('#flipbook').append(pg);
        }
        const {width,height,mode} = getFlipbookSize();
        $('#flipbook').turn({
          width, height,
          autoCenter:true,
          display:mode,
          duration:800,
          elevation:100,
          acceleration:true,
          gradients:true,
          turnCorners:'tl,tr'
        });
      }catch(e){
        alert('Erreur PDF : '+e.message);
      }finally{
        isLoading = false;
      }
    }

    /* === Ajustement layout sans re‑chargement === */
    function refreshFlipbookLayout(){
      if(isLoading || !$('#flipbook').data('turn')) return;
      const {width,height,mode} = getFlipbookSize();
      $('#flipbook').turn('display', mode);
      $('#flipbook').turn('size',    width, height);
    }

    /* === DOM ready === */
    $(async function(){
      applyAutoTheme();
      await ensurePDFLoaded($('#pdfSelector').val());

      /* Sélection d’un autre PDF */
      $('#pdfSelector').on('change', async function(){
        await ensurePDFLoaded(this.value);
      });

      /* Plein écran */
      $('#fullscreen').on('click',()=>{
        const el = document.documentElement;
        !document.fullscreenElement ? el.requestFullscreen?.() : document.exitFullscreen?.();
      });

      /* Réactions aux changements d’environnement */
      document.addEventListener('fullscreenchange', ()=> setTimeout(refreshFlipbookLayout, 200));
      $(window).on('resize',      ()=> {applyAutoTheme(); refreshFlipbookLayout();});
    });
  </script>
</body>
</html>
