<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Flipbook PDF V1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{margin:0;background:#111;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;}
    h1{margin:1rem 0;font-size:2rem;}
    #controls{display:flex;gap:1rem;align-items:center;margin-bottom:.5rem;}
    #controls button{padding:.6rem 1rem;background:#333;border:none;border-radius:6px;color:#fff;cursor:pointer;user-select:none;}
    #controls button:disabled{opacity:.5;cursor:default;}
    #status{margin-left:1rem;font-size:1rem;}
    #book-container{flex:1;display:flex;justify-content:center;align-items:center;width:100vw;overflow:hidden;}
    #flipbook{background:#fff;box-shadow:0 8px 32px rgba(0,0,0,.6);border-radius:8px;overflow:hidden;}
    .page{background:#fff;overflow:hidden;}
    .page canvas{display:block;width:100%;height:100%;}
  </style>
</head>
<body>

  <h1>Mon Livre PDF v1.1</h1>
  <div id="controls">
    <button id="prev">&laquo; Précédent</button>
    <button id="next">Suivant &raquo;</button>
    <button id="fs">Plein écran ⛶</button>
    <span id="status">Chargement…</span>
  </div>
  <div id="book-container">
    <div id="flipbook"></div>
  </div>

  <!-- Librairies locales -->
  <script src="libs/jquery.min.js"></script>
  <script src="libs/turn.min.js"></script>
  <script src="libs/pdf.js"></script>
  <script src="libs/pdf.worker.js"></script>
  <script>
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';

    const PDF_URL = 'pdf/livre.pdf';
    const flipbook = $('#flipbook');
    const prev = $('#prev'), next = $('#next'), fs = $('#fs'), status = $('#status');
    let pdfDoc, totalPages, current = 1;

    function displayMode() {
      return window.innerWidth > window.innerHeight ? 'double' : 'single';
    }

    function updateNav() {
      const mode = displayMode();
      prev.prop('disabled', current <= 1);
      next.prop('disabled', mode==='double'
        ? current+1 > totalPages
        : current >= totalPages
      );
      if(mode==='double') {
        status.text(`Pages ${current}-${Math.min(current+1,totalPages)} / ${totalPages}`);
      } else {
        status.text(`Page ${current} / ${totalPages}`);
      }
    }

    function initBook() {
      // détruit si existe
      if (flipbook.data('turn')) flipbook.turn('destroy').empty();
      // ajoute pages
      for (let i=1; i<=totalPages; i++) {
        flipbook.append($('<div/>',{ class:'page', 'data-page':i }));
      }
      // taille et init turn.js
      const mode = displayMode();
      const w = Math.min(window.innerWidth*0.9, 900);
      const h = Math.min(window.innerHeight*0.8, 600);
      flipbook.css({ width: w, height: h })
              .turn({
        width: w,
        height: h,
        display: mode,
        autoCenter: true,
        gradients: true,
        elevation: 100,
        duration: 700,
        cornerSize: 100,
        when: {
          turned: (e, p) => {
            current = p;
            renderVisible();
            updateNav();
          }
        }
      });
      // rend initial
      renderVisible();
      flipbook.turn('page', current);
      updateNav();
    }

    function renderPage(i) {
      const pageDiv = flipbook.find(`.page[data-page=${i}]`);
      if (pageDiv.data('rendered')) return;
      pdfDoc.getPage(i).then(page => {
        const viewport = page.getViewport({ scale:1 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        // adapter à la page
        const pw = flipbook.width() / (displayMode()==='double'?2:1);
        const ph = flipbook.height();
        const scale = Math.min(pw/viewport.width, ph/viewport.height);
        const vp = page.getViewport({ scale });
        canvas.width = vp.width; canvas.height = vp.height;
        page.render({ canvasContext: ctx, viewport: vp }).promise.then(() => {
          pageDiv.append(canvas).data('rendered', true);
        });
      });
    }

    function renderVisible() {
      renderPage(current);
      if (displayMode()==='double' && current+1<=totalPages) {
        renderPage(current+1);
      }
    }

    // Navigation
    prev.on('click', () => {
      if (displayMode()==='double') current = Math.max(1, current-2);
      else current = Math.max(1, current-1);
      flipbook.turn('page', current);
    });
    next.on('click', () => {
      if (displayMode()==='double') current = Math.min(current+2, totalPages);
      else current = Math.min(current+1, totalPages);
      flipbook.turn('page', current);
    });

    // plein écran
    fs.on('click', () => {
      const el = document.documentElement;
      if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
      setTimeout(initBook, 500);
    });

    // swipe
    flipbook.on('touchstart', e => {
      const t = e.originalEvent.touches[0].clientX; flipbook.data('x0',t);
    }).on('touchend', e => {
      const x0 = flipbook.data('x0'), x1 = e.originalEvent.changedTouches[0].clientX;
      if (x1-x0>50) prev.click();
      if (x0-x1>50) next.click();
    });

    // resize/orientation
    let to;
    $(window).on('resize orientationchange', () => {
      clearTimeout(to);
      to = setTimeout(initBook, 300);
    });

    // charge PDF
    pdfjsLib.getDocument(PDF_URL).promise.then(doc => {
      pdfDoc = doc; totalPages = doc.numPages;
      status.text(`0 / ${totalPages}`);
      initBook();
    }).catch(e => status.text('Erreur : '+e.message));

  </script>
</body>
</html>
