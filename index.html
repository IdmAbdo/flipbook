<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mon Livre PDF</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      background: #111; color: #fff; margin: 0; font-family: sans-serif;
    }
    h1 { text-align:center; margin:20px 0; }
    .nav {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;
    }
    button {
      padding: 12px 22px; background: #333; color: #fff; border-radius: 8px;
      border: none; font-size: 18px; margin: 2px 4px;
      transition: background 0.2s;
    }
    button:active { background: #555; }
    #status { font-size: 18px; margin-left: 18px; }
    #container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 70vh;
      width: 100vw;
    }
    #flipbook {
      background: #222;
      box-shadow: 0 8px 32px #0008;
      margin: auto;
      display: flex;
      justify-content: center;
      align-items: center;
      /* Default: desktop double page */
      width: 840px;
      height: 600px;
      transition: width 0.3s, height 0.3s;
    }
    @media (max-width: 900px) {
      #flipbook { width: 98vw !important; height: 67vw !important; max-width: 100vw; }
    }
    @media (max-width: 600px) {
      #flipbook { width: 99vw !important; height: 135vw !important; }
      button { font-size: 15px; }
    }
  </style>
</head>
<body>
  <h1>Mon Livre PDF</h1>
  <div class="nav">
    <button id="prev">« Précédent</button>
    <button id="next">Suivant »</button>
    <button id="fullscreen">Plein écran ⛶</button>
    <span id="status">Chargement…</span>
  </div>
  <div id="container">
    <div id="flipbook"></div>
  </div>
  <!-- Dépendances JS -->
  <script src="libs/jquery.min.js"></script>
  <script src="libs/turn.min.js"></script>
  <script src="libs/pdf.min.js"></script>
  <script>
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';

    // Taille d'une page (portrait)
    const PAGE_WIDTH = 420, PAGE_HEIGHT = 600;
    const PDF_URL = "pdf/livre.pdf";
    let pdfDoc = null, totalPages = 0;

    // -- Mode d'affichage : single (portrait/mobile), double (paysage/desktop)
    function getDisplayMode() {
      // Si largeur écran < hauteur (portrait) OU écran étroit (mobile) -> single
      return window.innerWidth < 700 || window.innerHeight > window.innerWidth ? "single" : "double";
    }

    // -- Corrige la navigation (désactive au début/fin)
    function updateNav() {
      const currentPage = $("#flipbook").turn("page");
      const lastPage = $("#flipbook").turn("pages");
      $("#prev").prop("disabled", currentPage <= 1);
      $("#next").prop("disabled", currentPage >= lastPage);
    }

    // --- Re-crée le flipbook selon la taille d'écran
    function createFlipbook(canvases) {
      let displayMode = getDisplayMode();
      // Détruit l'ancien flipbook s'il existe
      if ($("#flipbook").data("turn")) $("#flipbook").turn("destroy").empty();
      // Ajoute toutes les pages
      canvases.forEach(canvas => $("#flipbook").append(canvas));
      // Définit la taille et l'affichage
      let width = displayMode === "double" ? PAGE_WIDTH * 2 : PAGE_WIDTH;
      let height = PAGE_HEIGHT;
      $("#flipbook").css({width: width + "px", height: height + "px"});
      // Initialise turn.js
      $("#flipbook").turn({
        width: width,
        height: height,
        autoCenter: true,
        acceleration: true,
        display: displayMode,
        gradients: true,
        elevation: 50,
        when: {
          turned: function(e, page) {
            // Affichage du statut (ex : page 2-3/11 ou 3/11)
            let t = (displayMode === "double") ?
              `Pages ${page}-${Math.min(page+1,totalPages)} / ${totalPages}` :
              `Page ${page} / ${totalPages}`;
            $("#status").text(t);
            updateNav();
          }
        }
      });
      updateNav();
    }

    // -- Plein écran
    function openFullscreen(elem) {
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    }
    document.getElementById('fullscreen').onclick = function() {
      openFullscreen(document.getElementById('flipbook'));
    };

    // Navigation boutons
    $("#prev").on("click", function() {
      $("#flipbook").turn("previous");
    });
    $("#next").on("click", function() {
      $("#flipbook").turn("next");
    });

    // -- Rendu PDF -> Canvas
    function renderPage(num) {
      return pdfDoc.getPage(num).then(function(page) {
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = PAGE_WIDTH;
        canvas.height = PAGE_HEIGHT;
        const viewport = page.getViewport({ scale: PAGE_WIDTH / page.getViewport({scale:1}).width });
        return page.render({canvasContext: context, viewport: viewport}).promise.then(function() {
          return canvas;
        });
      });
    }

    // -- Charge le PDF et prépare le flipbook
    let canvasesGlobal = null;
    pdfjsLib.getDocument(PDF_URL).promise.then(function(pdf) {
      pdfDoc = pdf;
      totalPages = pdf.numPages;
      $("#status").text(`0 / ${totalPages} pages chargées`);
      let promises = [];
      for(let i=1; i<=totalPages; i++) promises.push(renderPage(i));
      Promise.all(promises).then(function(canvases) {
        canvasesGlobal = canvases;
        createFlipbook(canvases);
        $("#status").text(`${totalPages} pages`);
      });
    }).catch(function(err){
      $("#status").text("Erreur PDF : " + err.message);
    });

    // -- Responsive : recrée le flipbook au changement d’orientation ou redimensionnement
    window.addEventListener('resize', function() {
      if(canvasesGlobal) createFlipbook(canvasesGlobal);
    });
    window.addEventListener('orientationchange', function() {
      if(canvasesGlobal) createFlipbook(canvasesGlobal);
    });

  </script>
</body>
</html>
